<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PGB2 Report Sender - Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      :root {
        --primary-dark: #0e1e40;
        --primary: #2842b1;
        --secondary: #5068e2;
        --accent: #7510f7;
        --teal: #10d9de;
        --light: #f8f9fa;
        --dark: #212529;
        --success: #28a745;
        --danger: #dc3545;
        --warning: #ffc107;
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--light);
        color: var(--dark);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-top: 0;
        position: relative;
        overflow-x: hidden;
      }

      .bg-animation {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
      }

      .wave {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100px;
        background-size: 1440px 100px;
        animation: wave-animation 12s linear infinite;
        opacity: 0.1;
      }

      .wave:nth-child(1) {
        bottom: 0;
        opacity: 0.1;
        background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg"><path fill="%2310d9de" fill-opacity="0.3" d="M0,160L48,144C96,128,192,96,288,106.7C384,117,480,171,576,197.3C672,224,768,224,864,192C960,160,1056,96,1152,74.7C1248,53,1344,75,1392,85.3L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
      }

      .wave:nth-child(2) {
        bottom: 10px;
        opacity: 0.05;
        background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg"><path fill="%232842b1" fill-opacity="0.3" d="M0,64L48,96C96,128,192,192,288,213.3C384,235,480,213,576,186.7C672,160,768,128,864,128C960,128,1056,160,1152,170.7C1248,181,1344,171,1392,165.3L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
        animation: wave-animation 8s linear infinite;
      }

      .wave:nth-child(3) {
        bottom: 20px;
        opacity: 0.02;
        background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg"><path fill="%237510F7" fill-opacity="0.3" d="M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
        animation: wave-animation 10s linear infinite;
      }

      @keyframes wave-animation {
        0% {
          background-position-x: 0;
        }
        100% {
          background-position-x: 1440px;
        }
      }

      .container {
        position: relative;
        z-index: 1;
        padding-top: 2rem;
      }

      header {
        margin-bottom: 2rem;
      }

      .logo-container {
        display: flex;
        align-items: center;
      }

      .logo-text {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(
          90deg,
          var(--primary-dark) 0%,
          var(--accent) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-left: 1rem;
      }

      .header-subtitle {
        color: #666;
        font-weight: 400;
      }

      .btn {
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        border: none;
      }

      .btn-outline-primary {
        border: 2px solid var(--primary);
        color: var(--primary);
        background: white;
      }

      .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
      }

      .btn-success {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        border: none;
      }

      .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        height: 100%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        border: none;
      }

      .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 0.5rem;
      }

      .card-text {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .text-success {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .text-danger {
        background: linear-gradient(90deg, #dc3545 0%, #f86a6a 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 500;
      }

      .bg-success {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
      }

      .bg-danger {
        background: linear-gradient(90deg, #dc3545 0%, #f86a6a 100%);
      }

      .bg-warning {
        background: linear-gradient(90deg, #ffc107 0%, #ffb300 100%);
      }

      .card {
        border-radius: 15px;
        border: none;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
      }

      .card:hover {
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        background: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.5rem;
      }

      .nav-tabs {
        border: none;
      }

      .nav-tabs .nav-link {
        border: none;
        color: #666;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        margin-right: 0.5rem;
      }

      .nav-tabs .nav-link.active {
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--accent) 100%
        );
        color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      /* Chart container styles */
      .chart-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }

      .chart-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(
          90deg,
          #10d9de 0%,
          #2842b1 50%,
          #7510f7 100%
        );
      }

      .chart-container h4 {
        color: #0e1e40;
        font-weight: 700;
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
      }

      /* Canvas container for the chart */
      .chart-canvas-container {
        position: relative;
        height: 350px;
        width: 100%;
        margin-bottom: 1rem;
      }

      /* Chart filter buttons */
      .chart-filters {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .chart-filter {
        border: none;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        color: #666;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .chart-filter:hover {
        background: rgba(40, 66, 177, 0.1);
      }

      .chart-filter.active {
        background: linear-gradient(90deg, #2842b1 0%, #7510f7 100%);
        color: white;
      }

      /* Chart legend styles */
      .chart-legend {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #666;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 6px;
      }

      /* Chart info box */
      .chart-info {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background-color: rgba(16, 217, 222, 0.05);
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .chart-info i {
        color: #10d9de;
        font-size: 18px;
        margin-right: 12px;
      }

      .chart-info-text {
        font-size: 0.9rem;
        color: #666;
      }

      /* Future data legend indicator */
      .future-data-legend {
        display: flex;
        align-items: center;
        margin-top: 10px;
        font-size: 0.8rem;
        color: #666;
      }

      .dashed-line {
        width: 20px;
        height: 0;
        border-top: 2px dashed #666;
        margin-right: 8px;
      }

      /* Loading indicator for charts */
      .chart-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .chart-loading.active {
        opacity: 1;
        pointer-events: auto;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid rgba(40, 66, 177, 0.1);
        border-top-color: #2842b1;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .table {
        border-radius: 15px;
        overflow: hidden;
      }

      .table thead th {
        background: rgba(40, 66, 177, 0.05);
        border: none;
        color: var(--primary-dark);
        font-weight: 600;
      }

      .table tbody td {
        border-color: rgba(0, 0, 0, 0.05);
        vertical-align: middle;
      }

      .log-entry {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        transition: var(--transition);
      }

      .log-entry:hover {
        transform: translateX(5px);
      }

      .log-entry.error {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
      }

      .log-entry.info {
        background-color: rgba(40, 66, 177, 0.1);
        border-left: 4px solid var(--primary);
      }

      .log-entry.warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
      }

      .report-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        border-left: 5px solid #4caf50;
      }

      .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }

      .report-card.failed {
        border-left-color: #dc3545;
      }

      .report-card.pending {
        border-left-color: #ffc107;
      }

      .report-card .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
      }

      .report-card .card-subtitle {
        color: #666;
        margin-bottom: 1rem;
      }

      /* Style dla edytowalnych komórek */
      .editable-cell {
        background-color: rgba(255, 255, 200, 0.2);
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        position: relative;
        cursor: text;
      }

      .editable-cell:hover {
        background-color: rgba(255, 255, 200, 0.5);
        box-shadow: 0 0 5px rgba(40, 66, 177, 0.15);
      }

      .editable-cell:focus {
        background-color: rgba(255, 255, 200, 0.8);
        outline: 2px solid var(--primary);
        box-shadow: 0 0 8px rgba(40, 66, 177, 0.3);
      }

      .editable-cell::after {
        content: "";
        position: absolute;
        bottom: 0;
        right: 0;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 0 8px 8px;
        border-color: transparent transparent rgba(40, 66, 177, 0.3) transparent;
      }

      /* Style dla tabeli z danymi Excel */
      #excelDataTable {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      #excelDataTable thead th {
        background: linear-gradient(
          90deg,
          rgba(40, 66, 177, 0.05) 0%,
          rgba(117, 16, 247, 0.05) 100%
        );
        padding: 1rem;
        font-weight: 600;
        color: var(--primary-dark);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      #excelDataTable tbody td {
        padding: 0.75rem 1rem;
        transition: background-color 0.2s ease;
      }

      #excelDataTable tbody tr:hover td {
        background-color: rgba(16, 217, 222, 0.05);
      }

      /* Animacja dla przycisku zapisz */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
      }

      #saveExcelChanges {
        animation: pulse 2s infinite;
      }

      /* Style dla alertów */
      #excelStatusAlert {
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        position: relative;
        transition: all 0.3s ease;
      }

      /* Styl dla form wgrywania pliku */
      #uploadExcelForm {
        border-radius: 10px;
        padding: 1.5rem;
        background-color: rgba(40, 66, 177, 0.02);
        border: 1px dashed rgba(40, 66, 177, 0.2);
        transition: all 0.3s ease;
      }

      #uploadExcelForm:hover {
        background-color: rgba(40, 66, 177, 0.05);
        border-color: rgba(40, 66, 177, 0.3);
      }

      /* Styl dla pola wyboru pliku */
      #excelFile {
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #excelFile:hover {
        background-color: rgba(16, 217, 222, 0.05);
      }

      /* Styl dla modalowego okna */
      .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .modal-header {
        background: linear-gradient(
          90deg,
          rgba(40, 66, 177, 0.05) 0%,
          rgba(117, 16, 247, 0.05) 100%
        );
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
      }

      .modal-footer {
        background-color: rgba(248, 249, 250, 0.5);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.5rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .container {
          padding-top: 1rem;
        }

        .btn {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }

        .stats-card {
          margin-bottom: 1rem;
        }

        .card-text {
          font-size: 1.5rem;
        }

        .logo-text {
          font-size: 1.5rem;
        }

        .chart-canvas-container {
          height: 250px;
        }

        .chart-container {
          padding: 1.5rem;
          margin-bottom: 1.5rem;
        }

        .chart-filters {
          flex-wrap: wrap;
        }

        .chart-filter {
          padding: 0.4rem 0.8rem;
          font-size: 0.8rem;
        }

        .editable-cell {
          padding: 0.3rem;
        }

        #excelDataTable {
          font-size: 0.9rem;
        }

        #excelDataTable thead th,
        #excelDataTable tbody td {
          padding: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Background Animation -->
    <div class="bg-animation">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>

    <div class="container">
      <header>
        <div class="row align-items-center">
          <div class="col-md-8">
            <div class="logo-container">
              <svg
                width="50"
                height="50"
                viewBox="0 0 300 100"
                xmlns="http://www.w3.org/2000/svg"
              >
                <defs>
                  <linearGradient
                    id="logoGradient"
                    x1="0%"
                    y1="0%"
                    x2="100%"
                    y2="0%"
                  >
                    <stop offset="0%" style="stop-color: #10d9de" />
                    <stop offset="50%" style="stop-color: #2842b1" />
                    <stop offset="100%" style="stop-color: #7510f7" />
                  </linearGradient>
                </defs>
                <path
                  d="M10,50 Q50,20 80,40 T150,30 T210,10"
                  stroke="url(#logoGradient)"
                  stroke-width="8"
                  fill="transparent"
                  stroke-linecap="round"
                />
                <rect
                  x="220"
                  y="0"
                  width="30"
                  height="30"
                  rx="5"
                  fill="#7510F7"
                />
                <text
                  x="225"
                  y="22"
                  fill="white"
                  font-family="Arial"
                  font-weight="bold"
                  font-size="18"
                >
                  PGB2
                </text>
              </svg>
              <h1 class="logo-text">PGB2 Report Sender</h1>
            </div>
            <p class="header-subtitle">
              System automatycznego wysyłania raportów do PGB2
            </p>
          </div>
          <div class="col-md-4 text-end">
            <button id="refreshBtn" class="btn btn-outline-primary me-2">
              <i class="bi bi-arrow-clockwise"></i> Odśwież dane
            </button>
            <button id="triggerReportBtn" class="btn btn-success">
              <i class="bi bi-send"></i> Wyślij raport
            </button>
          </div>
        </div>
      </header>

      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card">
            <h5 class="card-title">Łącznie raportów</h5>
            <h2 class="card-text">{{ stats.total_reports }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <h5 class="card-title">Sukces</h5>
            <h2 class="card-text text-success">{{ stats.success_count }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <h5 class="card-title">Błędy</h5>
            <h2 class="card-text text-danger">{{ stats.error_count }}</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <h5 class="card-title">Ostatni raport</h5>
            <p class="card-text" style="font-size: 1rem">
              {{ stats.last_report }}
            </p>
            <p class="card-text" style="font-size: 1rem">
              Status: {% if stats.last_status == "SUCCESSFULLY_PROCESSED" %}
              <span class="badge bg-success">Sukces</span>
              {% elif stats.last_status == "FAILED" %}
              <span class="badge bg-danger">Błąd</span>
              {% else %}
              <span class="badge bg-warning">{{ stats.last_status }}</span>
              {% endif %}
            </p>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="charts-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#charts"
                    type="button"
                    role="tab"
                    aria-controls="charts"
                    aria-selected="true"
                  >
                    Wykresy
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="logs-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#logs"
                    type="button"
                    role="tab"
                    aria-controls="logs"
                    aria-selected="false"
                  >
                    Logi systemu
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="data-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#data"
                    type="button"
                    role="tab"
                    aria-controls="data"
                    aria-selected="false"
                  >
                    Dane Excel
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="reports-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#reports"
                    type="button"
                    role="tab"
                    aria-controls="reports"
                    aria-selected="false"
                  >
                    Historia raportów
                  </button>
                </li>
              </ul>
            </div>
            <div class="card-body">
              <div class="tab-content">
                <div
                  class="tab-pane fade show active"
                  id="charts"
                  role="tabpanel"
                  aria-labelledby="charts-tab"
                >
                  <div class="chart-container">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h4>Zużycie i Produkcja PV</h4>
                      <div class="chart-filters">
                        <button
                          class="chart-filter"
                          data-period="month"
                          data-chart="consumption-production"
                        >
                          Miesiąc
                        </button>
                        <button
                          class="chart-filter"
                          data-period="year"
                          data-chart="consumption-production"
                        >
                          Rok
                        </button>
                      </div>
                    </div>

                    <div class="chart-info mb-3">
                      <i class="bi bi-info-circle-fill"></i>
                      <span class="chart-info-text"
                        >Porównanie zużycia i produkcji energii. Dane przyszłe
                        są pokazane linią przerywaną.</span
                      >
                    </div>

                    <div class="chart-legend">
                      <div class="legend-item">
                        <div
                          class="legend-color"
                          style="background-color: #2842b1"
                        ></div>
                        <span>Zużycie energii</span>
                      </div>
                      <div class="legend-item">
                        <div
                          class="legend-color"
                          style="background-color: #10d9de"
                        ></div>
                        <span>Produkcja PV</span>
                      </div>
                    </div>

                    <div class="chart-canvas-container">
                      <canvas id="consumption-production-chart"></canvas>
                      <div
                        class="chart-loading"
                        id="consumption-production-loading"
                      >
                        <div class="loading-spinner"></div>
                      </div>
                    </div>
                    <div class="future-data-legend">
                      <div class="dashed-line"></div>
                      <span>Dane przyszłe (prognoza)</span>
                    </div>
                  </div>

                  <div class="chart-container">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h4>Bilans energii</h4>
                      <div class="chart-filters">
                        <button
                          class="chart-filter"
                          data-period="month"
                          data-chart="balance"
                        >
                          Miesiąc
                        </button>
                        <button
                          class="chart-filter"
                          data-period="year"
                          data-chart="balance"
                        >
                          Rok
                        </button>
                      </div>
                    </div>

                    <div class="chart-info mb-3">
                      <i class="bi bi-info-circle-fill"></i>
                      <span class="chart-info-text"
                        >Bilans energii: różnica między produkcją a zużyciem.
                        Dane przyszłe są pokazane linią przerywaną.</span
                      >
                    </div>

                    <div class="chart-legend">
                      <div class="legend-item">
                        <div
                          class="legend-color"
                          style="background-color: #7510f7"
                        ></div>
                        <span>Bilans energii</span>
                      </div>
                    </div>

                    <div class="chart-canvas-container">
                      <canvas id="balance-chart"></canvas>
                      <div class="chart-loading" id="balance-loading">
                        <div class="loading-spinner"></div>
                      </div>
                    </div>
                    <div class="future-data-legend">
                      <div class="dashed-line"></div>
                      <span>Dane przyszłe (prognoza)</span>
                    </div>
                  </div>

                  <div class="chart-container">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h4>PPLAN i PAUTO</h4>
                      <div class="chart-filters">
                        <button
                          class="chart-filter"
                          data-period="month"
                          data-chart="pplan-pauto"
                        >
                          Miesiąc
                        </button>
                        <button
                          class="chart-filter"
                          data-period="year"
                          data-chart="pplan-pauto"
                        >
                          Rok
                        </button>
                      </div>
                    </div>

                    <div class="chart-info mb-3">
                      <i class="bi bi-info-circle-fill"></i>
                      <span class="chart-info-text"
                        >Wartości raportowane do PGB2. Dane przyszłe są pokazane
                        linią przerywaną.</span
                      >
                    </div>

                    <div class="chart-legend">
                      <div class="legend-item">
                        <div
                          class="legend-color"
                          style="background-color: #10d9de"
                        ></div>
                        <span>PPLAN</span>
                      </div>
                      <div class="legend-item">
                        <div
                          class="legend-color"
                          style="background-color: #7510f7"
                        ></div>
                        <span>PAUTO</span>
                      </div>
                    </div>

                    <div class="chart-canvas-container">
                      <canvas id="pplan-pauto-chart"></canvas>
                      <div class="chart-loading" id="pplan-pauto-loading">
                        <div class="loading-spinner"></div>
                      </div>
                    </div>
                    <div class="future-data-legend">
                      <div class="dashed-line"></div>
                      <span>Dane przyszłe (prognoza)</span>
                    </div>
                  </div>
                </div>

                <div
                  class="tab-pane fade"
                  id="logs"
                  role="tabpanel"
                  aria-labelledby="logs-tab"
                >
                  <h4 class="mb-4">Ostatnie logi systemu</h4>
                  <div class="logs-container">
                    {% for log in logs|reverse %}
                    <div
                      class="log-entry {% if log.type == 'error' %}error{% elif log.type == 'warning' %}warning{% else %}info{% endif %}"
                    >
                      <strong>{{ log.timestamp }}</strong> [{{ log.type }}]: {{
                      log.message }}
                    </div>
                    {% else %}
                    <p>Brak logów systemowych</p>
                    {% endfor %}
                  </div>
                </div>

                <!-- Zakładka Dane Excel -->
                <div
                  class="tab-pane fade"
                  id="data"
                  role="tabpanel"
                  aria-labelledby="data-tab"
                >
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <h4 class="mb-3">Przetworzone dane</h4>
                      <p class="text-muted">
                        Ostatnia aktualizacja: {{
                        processed_data.last_processed_date }}
                      </p>
                    </div>
                    <div
                      class="col-md-6 text-end"
                      style="padding-top: 10px; gap: 20px"
                    >
                      <button
                        id="toggleEditMode"
                        class="btn btn-outline-primary"
                      >
                        <i class="bi bi-pencil"></i> Włącz tryb edycji
                      </button>
                      <!-- Przycisk zapisujący zmiany -->

                      <button
                        id="saveExcelChanges"
                        class="btn btn-success"
                        style="display: none"
                      >
                        <i class="bi bi-save"></i> Zapisz zmiany
                      </button>
                      <!-- Przycisk otwierający modal do wgrywania pliku -->
                      <button
                        type="button"
                        class="btn btn-primary ml-2"
                        data-bs-toggle="modal"
                        data-bs-target="#uploadExcelModal"
                      >
                        <i class="bi bi-upload"></i> Wgraj nowy plik Excel
                      </button>
                    </div>
                  </div>

                  <!-- Alert na informacje o statusie operacji -->
                  <div
                    id="excelStatusAlert"
                    class="alert"
                    style="display: none"
                  ></div>

                  <!-- Tabela z danymi Excel -->
                  <div class="table-responsive">
                    <table
                      id="excelDataTable"
                      class="table table-striped table-hover"
                    >
                      <thead>
                        <tr id="excelTableHeader">
                          <!-- Nagłówki będą generowane dynamicznie -->
                        </tr>
                      </thead>
                      <tbody id="excelTableBody">
                        <!-- Dane będą generowane dynamicznie -->
                      </tbody>
                    </table>
                  </div>

                  <!-- Przycisk włączający/wyłączający tryb edycji -->
                </div>

                <div
                  class="tab-pane fade"
                  id="reports"
                  role="tabpanel"
                  aria-labelledby="reports-tab"
                >
                  <h4 class="mb-4">Historia wysłanych raportów</h4>
                  <div class="reports-container">
                    {% for report in sent_reports|reverse %}
                    <div
                      class="report-card {% if report.status == 'FAILED' %}failed{% elif report.status == 'SUCCESSFULLY_PROCESSED' %}success{% else %}pending{% endif %}"
                    >
                      <h5 class="card-title">Raport {{ report.uuid }}</h5>
                      <h6 class="card-subtitle mb-2 text-muted">
                        {{ report.timestamp }}
                      </h6>
                      <p>
                        Typ: {{ report.type }}<br />
                        Status: {% if report.status == "SUCCESSFULLY_PROCESSED"
                        %}
                        <span class="badge bg-success">Sukces</span>
                        {% elif report.status == "FAILED" %}
                        <span class="badge bg-danger">Błąd</span>
                        {% else %}
                        <span class="badge bg-warning"
                          >{{ report.status }}</span
                        >
                        {% endif %}
                      </p>
                    </div>
                    {% else %}
                    <p>Brak wysłanych raportów</p>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal do wgrywania pliku Excel -->
    <div
      class="modal fade"
      id="uploadExcelModal"
      tabindex="-1"
      aria-labelledby="uploadExcelModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadExcelModalLabel">
              Wgraj nowy plik Excel
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="uploadExcelForm" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="excelFile" class="form-label"
                  >Wybierz plik Excel</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="excelFile"
                  name="file"
                  accept=".xlsx,.xls"
                />
                <div class="form-text">Akceptowane formaty: .xlsx, .xls</div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="replaceExisting"
                    name="replace"
                    checked
                  />
                  <label class="form-check-label" for="replaceExisting">
                    Zastąp istniejący plik
                  </label>
                </div>
              </div>
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle-fill"></i> Uwaga: Wgranie
                nowego pliku może wpłynąć na przyszłe raporty. Upewnij się, że
                plik ma poprawną strukturę zgodną z dokumentacją systemu.
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Anuluj
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="submitExcelUpload"
            >
              Wgraj plik
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Declare chartData variable before using it
      let chartData;
      let currentPeriod = "year";

      // Initialize chart data with proper JSON handling
      try {
        const decodedData = `{{ chart_data }}`.replace(/&#34;/g, '"');
        chartData = JSON.parse(decodedData);
      } catch (e) {
        console.error("Error parsing chart data:", e);
        // Fallback to empty data structure
        chartData = {
          month: {
            dates: [],
            consumption: [],
            production: [],
            balance: [],
            pplan: [],
            pauto: [],
            is_future: [],
          },
          year: {
            dates: [],
            consumption: [],
            production: [],
            balance: [],
            pplan: [],
            pauto: [],
            is_future: [],
          },
        };
      }

      // Chart instances
      let consumptionProductionChart = null;
      let balanceChart = null;
      let pplanPautoChart = null;

      // Colors
      const colors = {
        consumption: "#2842b1",
        production: "#10d9de",
        balance: "#7510F7",
        pplan: "#10d9de",
        pauto: "#7510F7",
      };

      // Initialize charts when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeCharts("year");

        // Set active filters
        document
          .querySelectorAll('.chart-filter[data-period="year"]')
          .forEach((btn) => {
            btn.classList.add("active");
          });

        // Add event listeners to chart filters
        document.querySelectorAll(".chart-filter").forEach((button) => {
          button.addEventListener("click", function () {
            const period = this.getAttribute("data-period");
            const chartType = this.getAttribute("data-chart");

            // Remove active class from all buttons in this chart group
            document
              .querySelectorAll(`.chart-filter[data-chart="${chartType}"]`)
              .forEach((btn) => {
                btn.classList.remove("active");
              });

            // Add active class to clicked button
            this.classList.add("active");

            // Update the chart
            updateChart(chartType, period);
          });
        });
      });

      // Initialize all charts
      function initializeCharts(period) {
        if (!chartData || !chartData[period]) {
          console.error("Chart data not available for period:", period);
          return;
        }

        // Create consumption and production chart
        createConsumptionProductionChart(period);

        // Create balance chart
        createBalanceChart(period);

        // Create PPLAN and PAUTO chart
        createPplanPautoChart(period);
      }

      // Create consumption and production chart
      function createConsumptionProductionChart(period) {
        const ctx = document
          .getElementById("consumption-production-chart")
          .getContext("2d");

        if (consumptionProductionChart) {
          consumptionProductionChart.destroy();
        }

        const data = chartData[period];

        // Split data into past and future
        const {
          pastDates,
          futureDates,
          pastConsumption,
          futureConsumption,
          pastProduction,
          futureProduction,
        } = splitData(
          data.dates,
          data.consumption,
          data.production,
          data.is_future
        );

        consumptionProductionChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [...pastDates, ...futureDates],
            datasets: [
              {
                label: "Zużycie (historyczne)",
                data: pastConsumption,
                borderColor: colors.consumption,
                backgroundColor: "rgba(40, 66, 177, 0.1)",
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
              {
                label: "Zużycie (prognoza)",
                data: createConnectedData(pastConsumption, futureConsumption),
                borderColor: colors.consumption,
                backgroundColor: "rgba(40, 66, 177, 0.1)",
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
              {
                label: "Produkcja PV (historyczna)",
                data: pastProduction,
                borderColor: colors.production,
                backgroundColor: "rgba(16, 217, 222, 0.1)",
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
              {
                label: "Produkcja PV (prognoza)",
                data: createConnectedData(pastProduction, futureProduction),
                borderColor: colors.production,
                backgroundColor: "rgba(16, 217, 222, 0.1)",
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                title: {
                  display: true,
                  text: "kW",
                },
              },
              x: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
              },
            },
          },
        });
      }

      // Create balance chart
      function createBalanceChart(period) {
        const ctx = document.getElementById("balance-chart").getContext("2d");

        if (balanceChart) {
          balanceChart.destroy();
        }

        const data = chartData[period];

        // Split data into past and future
        const { pastDates, futureDates, pastBalance, futureBalance } =
          splitBalanceData(data.dates, data.balance, data.is_future);

        balanceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [...pastDates, ...futureDates],
            datasets: [
              {
                label: "Bilans energii (historyczny)",
                data: pastBalance,
                borderColor: colors.balance,
                backgroundColor: function (context) {
                  const chart = context.chart;
                  const { ctx, chartArea } = chart;
                  if (!chartArea) {
                    return null;
                  }
                  const gradient = ctx.createLinearGradient(
                    0,
                    chartArea.bottom,
                    0,
                    chartArea.top
                  );
                  gradient.addColorStop(0.5, "rgba(117, 16, 247, 0)");
                  gradient.addColorStop(1, "rgba(117, 16, 247, 0.2)");
                  return gradient;
                },
                tension: 0.4,
                fill: "origin",
                borderWidth: 3,
              },
              {
                label: "Bilans energii (prognoza)",
                data: createConnectedData(pastBalance, futureBalance),
                borderColor: colors.balance,
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                title: {
                  display: true,
                  text: "kW",
                },
              },
              x: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
              },
            },
          },
        });
      }

      // Create PPLAN and PAUTO chart
      function createPplanPautoChart(period) {
        const ctx = document
          .getElementById("pplan-pauto-chart")
          .getContext("2d");

        if (pplanPautoChart) {
          pplanPautoChart.destroy();
        }

        const data = chartData[period];

        // Split data into past and future
        const {
          pastDates,
          futureDates,
          pastPplan,
          futurePplan,
          pastPauto,
          futurePauto,
        } = splitPlanData(data.dates, data.pplan, data.pauto, data.is_future);

        pplanPautoChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [...pastDates, ...futureDates],
            datasets: [
              {
                label: "PPLAN (historyczny)",
                data: pastPplan,
                borderColor: colors.pplan,
                backgroundColor: "rgba(16, 217, 222, 0.1)",
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
              {
                label: "PPLAN (prognoza)",
                data: createConnectedData(pastPplan, futurePplan),
                borderColor: colors.pplan,
                backgroundColor: "rgba(16, 217, 222, 0.1)",
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
              {
                label: "PAUTO (historyczny)",
                data: pastPauto,
                borderColor: colors.pauto,
                backgroundColor: "rgba(117, 16, 247, 0.1)",
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
              {
                label: "PAUTO (prognoza)",
                data: createConnectedData(pastPauto, futurePauto),
                borderColor: colors.pauto,
                backgroundColor: "rgba(117, 16, 247, 0.1)",
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                borderWidth: 3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                title: {
                  display: true,
                  text: "kW",
                },
              },
              x: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
              },
            },
          },
        });
      }

      // Helper function to create connected data between past and future
      function createConnectedData(pastData, futureData) {
        // Create array with nulls for past dates except for the last entry
        let result = Array(pastData.length).fill(null);

        // If we have past data, add the last past value to connect with future data
        if (pastData.length > 0) {
          result[pastData.length - 1] = pastData[pastData.length - 1];
        }

        // Concat future data
        return result.concat(futureData);
      }

      // Helper function to split data into past and future
      function splitData(dates, consumption, production, isFuture) {
        const pastDates = [];
        const futureDates = [];
        const pastConsumption = [];
        const futureConsumption = [];
        const pastProduction = [];
        const futureProduction = [];

        dates.forEach((date, i) => {
          if (isFuture[i]) {
            futureDates.push(date);
            futureConsumption.push(consumption[i]);
            futureProduction.push(production[i]);
          } else {
            pastDates.push(date);
            pastConsumption.push(consumption[i]);
            pastProduction.push(production[i]);
          }
        });

        return {
          pastDates,
          futureDates,
          pastConsumption,
          futureConsumption,
          pastProduction,
          futureProduction,
        };
      }

      // Helper function to split balance data
      function splitBalanceData(dates, balance, isFuture) {
        const pastDates = [];
        const futureDates = [];
        const pastBalance = [];
        const futureBalance = [];

        dates.forEach((date, i) => {
          if (isFuture[i]) {
            futureDates.push(date);
            futureBalance.push(balance[i]);
          } else {
            pastDates.push(date);
            pastBalance.push(balance[i]);
          }
        });

        return {
          pastDates,
          futureDates,
          pastBalance,
          futureBalance,
        };
      }

      // Helper function to split plan data
      function splitPlanData(dates, pplan, pauto, isFuture) {
        const pastDates = [];
        const futureDates = [];
        const pastPplan = [];
        const futurePplan = [];
        const pastPauto = [];
        const futurePauto = [];

        dates.forEach((date, i) => {
          if (isFuture[i]) {
            futureDates.push(date);
            futurePplan.push(pplan[i]);
            futurePauto.push(pauto[i]);
          } else {
            pastDates.push(date);
            pastPplan.push(pplan[i]);
            pastPauto.push(pauto[i]);
          }
        });

        return {
          pastDates,
          futureDates,
          pastPplan,
          futurePplan,
          pastPauto,
          futurePauto,
        };
      }

      // Function to update a chart with new data
      function updateChart(chartType, period) {
        currentPeriod = period;
        showLoading(chartType);

        // Fetch updated data from server if needed
        fetchUpdatedData(period)
          .then(() => {
            switch (chartType) {
              case "consumption-production":
                createConsumptionProductionChart(period);
                break;
              case "balance":
                createBalanceChart(period);
                break;
              case "pplan-pauto":
                createPplanPautoChart(period);
                break;
            }
            hideLoading(chartType);
          })
          .catch((error) => {
            console.error(`Error updating ${chartType} chart:`, error);
            hideLoading(chartType);
          });
      }

      // Function to fetch updated data from server
      function fetchUpdatedData(period) {
        return new Promise((resolve, reject) => {
          // If we already have data for this period, just use it
          if (chartData && chartData[period]) {
            resolve(chartData[period]);
            return;
          }

          // Otherwise, fetch from server
          fetch(`/api/chart-data?period=${period}`)
            .then((response) => response.json())
            .then((result) => {
              if (result.status === "success") {
                chartData[period] = result.data;
                resolve(result.data);
              } else {
                reject(new Error(result.message));
              }
            })
            .catch(reject);
        });
      }

      // Functions to show and hide loading indicators
      function showLoading(chartType) {
        document.getElementById(`${chartType}-loading`).classList.add("active");
      }

      function hideLoading(chartType) {
        document
          .getElementById(`${chartType}-loading`)
          .classList.remove("active");
      }

      // API function to refresh chart data
      function refreshChartData() {
        // Show all loading indicators
        showLoading("consumption-production");
        showLoading("balance");
        showLoading("pplan-pauto");

        fetch(`/api/chart-data?period=${currentPeriod}`)
          .then((response) => response.json())
          .then((result) => {
            if (result.status === "success") {
              // Update chart data
              chartData[currentPeriod] = result.data;

              // Update charts
              updateChart("consumption-production", currentPeriod);
              updateChart("balance", currentPeriod);
              updateChart("pplan-pauto", currentPeriod);
            } else {
              console.error("Error fetching chart data:", result.message);

              // Hide all loading indicators
              hideLoading("consumption-production");
              hideLoading("balance");
              hideLoading("pplan-pauto");
            }
          })
          .catch((error) => {
            console.error("Error fetching chart data:", error);

            // Hide all loading indicators
            hideLoading("consumption-production");
            hideLoading("balance");
            hideLoading("pplan-pauto");
          });
      }

      // Odświeżanie strony
      document
        .getElementById("refreshBtn")
        .addEventListener("click", function () {
          refreshChartData();
        });

      // Wysyłanie raportu ręcznie
      document
        .getElementById("triggerReportBtn")
        .addEventListener("click", function () {
          if (confirm("Czy na pewno chcesz ręcznie wysłać raport teraz?")) {
            fetch("/trigger-report", {
              method: "POST",
            })
              .then((response) => response.json())
              .then((data) => {
                alert(data.message);
                setTimeout(() => window.location.reload(), 2000);
              })
              .catch((error) => {
                console.error("Błąd:", error);
                alert("Wystąpił błąd podczas wysyłania raportu");
              });
          }
        });

      // Automatyczne odświeżanie co 5 minut
      setInterval(function () {
        refreshChartData();
      }, 5 * 60 * 1000);

      // Zmienne globalne do przechowywania danych Excel
      let excelData = [];
      let isEditMode = false;
      let originalData = [];

      // Po załadowaniu DOM
      document.addEventListener("DOMContentLoaded", function () {
        // Załaduj dane Excel
        loadExcelData();

        // Obsługa przycisku przełączania trybu edycji
        document
          .getElementById("toggleEditMode")
          .addEventListener("click", toggleEditMode);

        // Obsługa zapisywania zmian
        document
          .getElementById("saveExcelChanges")
          .addEventListener("click", saveExcelChanges);

        // Obsługa wgrywania pliku Excel
        document
          .getElementById("submitExcelUpload")
          .addEventListener("click", uploadExcelFile);
      });

      // Funkcja ładująca dane Excel z API
      function loadExcelData() {
        fetch("/api/excel-data")
          .then((response) => response.json())
          .then((result) => {
            if (result.status === "success") {
              excelData = result.data;
              originalData = JSON.parse(JSON.stringify(result.data)); // Kopia głęboka
              renderExcelTable(excelData);
            } else {
              showAlert(
                "danger",
                "Błąd podczas ładowania danych: " + result.message
              );
            }
          })
          .catch((error) => {
            console.error("Błąd podczas ładowania danych Excel:", error);
            showAlert("danger", "Błąd podczas ładowania danych Excel");
          });
      }

      // Funkcja renderująca tabelę z danymi Excel
      function renderExcelTable(data) {
        if (!data || data.length === 0) {
          document.getElementById("excelTableBody").innerHTML =
            '<tr><td colspan="100%" class="text-center">Brak danych</td></tr>';
          return;
        }

        // Generowanie nagłówków
        const headers = Object.keys(data[0]);
        const headerRow = document.getElementById("excelTableHeader");
        headerRow.innerHTML = "";

        headers.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header;
          headerRow.appendChild(th);
        });

        // Generowanie wierszy danych
        const tableBody = document.getElementById("excelTableBody");
        tableBody.innerHTML = "";

        data.forEach((row, rowIndex) => {
          const tr = document.createElement("tr");
          tr.dataset.rowIndex = rowIndex;

          headers.forEach((header) => {
            const td = document.createElement("td");
            td.dataset.field = header;

            // W trybie edycji, niektóre komórki są edytowalne
            if (isEditMode && isEditableField(header)) {
              td.contentEditable = true;
              td.classList.add("editable-cell");
            }

            // Formatowanie daty jeśli to kolumna DATA
            if (header === "DATA" && row[header]) {
              // Sprawdzenie czy to obiekt daty czy string
              if (
                typeof row[header] === "string" &&
                row[header].includes("T")
              ) {
                // Format ISO - konwersja na przyjazny format
                const date = new Date(row[header]);
                td.textContent = date.toLocaleString();
              } else {
                td.textContent = row[header];
              }
            } else {
              td.textContent = row[header] !== null ? row[header] : "";
            }

            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });
      }

      // Funkcja określająca, które pola mogą być edytowane
      function isEditableField(fieldName) {
        // Kolumny, które NIE mogą być edytowane
        const nonEditableFields = ["DATA", "id", "_id"];
        return !nonEditableFields.includes(fieldName);
      }

      // Funkcja przełączająca tryb edycji
      function toggleEditMode() {
        isEditMode = !isEditMode;
        const button = document.getElementById("toggleEditMode");
        const saveButton = document.getElementById("saveExcelChanges");

        if (isEditMode) {
          button.innerHTML =
            '<i class="bi bi-x-circle"></i> Wyłącz tryb edycji';
          button.classList.replace("btn-outline-primary", "btn-outline-danger");
          saveButton.style.display = "inline-block";
        } else {
          button.innerHTML = '<i class="bi bi-pencil"></i> Włącz tryb edycji';
          button.classList.replace("btn-outline-danger", "btn-outline-primary");
          saveButton.style.display = "none";

          // Pytanie o powrót do oryginalnych danych przy wyjściu z trybu edycji
          if (hasDataChanged()) {
            if (confirm("Masz niezapisane zmiany. Czy chcesz je odrzucić?")) {
              loadExcelData(); // Przywróć oryginalne dane
            } else {
              isEditMode = true; // Pozostań w trybie edycji
              button.innerHTML =
                '<i class="bi bi-x-circle"></i> Wyłącz tryb edycji';
              button.classList.replace(
                "btn-outline-primary",
                "btn-outline-danger"
              );
              saveButton.style.display = "inline-block";
              return;
            }
          }
        }

        // Renderuj tabelę ponownie z nowym trybem
        renderExcelTable(excelData);
      }

      // Funkcja sprawdzająca, czy dane zostały zmienione
      function hasDataChanged() {
        const cells = document.querySelectorAll(".editable-cell");
        for (const cell of cells) {
          const rowIndex = cell.parentElement.dataset.rowIndex;
          const fieldName = cell.dataset.field;
          const originalValue = originalData[rowIndex][fieldName];
          const currentValue = cell.textContent;

          // Konwertuj wartości do porównania
          const origVal =
            originalValue !== null ? originalValue.toString() : "";
          const currVal = currentValue !== null ? currentValue.toString() : "";

          if (origVal !== currVal) {
            return true;
          }
        }
        return false;
      }

      // Funkcja zbierająca zmiany z tabeli
      function collectChangesFromTable() {
        // Zbierz wszystkie zmiany z edytowalnych komórek
        const changedData = JSON.parse(JSON.stringify(excelData)); // Kopia głęboka

        document.querySelectorAll(".editable-cell").forEach((cell) => {
          const rowIndex = parseInt(cell.parentElement.dataset.rowIndex);
          const fieldName = cell.dataset.field;
          const newValue = cell.textContent.trim();

          // Konwersja typu - zakładamy, że liczby powinny być liczbami, nie stringami
          if (!isNaN(newValue) && newValue !== "") {
            changedData[rowIndex][fieldName] = parseFloat(newValue);
          } else {
            changedData[rowIndex][fieldName] =
              newValue === "" ? null : newValue;
          }
        });

        return changedData;
      }

      // Funkcja zapisująca zmiany w danych Excel
      function saveExcelChanges() {
        const changedData = collectChangesFromTable();

        // Pokaż potwierdzenie
        if (
          confirm(
            "Czy na pewno chcesz zapisać zmiany? Ta operacja nie może być cofnięta."
          )
        ) {
          // Wyślij dane do API
          fetch("/api/update-excel-data", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              data: changedData,
            }),
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.status === "success") {
                showAlert("success", "Dane zostały pomyślnie zapisane");

                // Aktualizuj lokalną kopię danych
                excelData = changedData;
                originalData = JSON.parse(JSON.stringify(changedData));

                // Wyłącz tryb edycji
                isEditMode = false;
                const button = document.getElementById("toggleEditMode");
                button.innerHTML =
                  '<i class="bi bi-pencil"></i> Włącz tryb edycji';
                button.classList.replace(
                  "btn-outline-danger",
                  "btn-outline-primary"
                );
                document.getElementById("saveExcelChanges").style.display =
                  "none";

                // Odśwież widok tabeli
                renderExcelTable(excelData);
              } else {
                showAlert(
                  "danger",
                  "Błąd zapisywania danych: " + result.message
                );
              }
            })
            .catch((error) => {
              console.error("Błąd podczas zapisywania danych:", error);
              showAlert("danger", "Błąd podczas zapisywania danych");
            });
        }
      }

      // Funkcja wgrywająca nowy plik Excel
      function uploadExcelFile() {
        const fileInput = document.getElementById("excelFile");
        const replaceExisting =
          document.getElementById("replaceExisting").checked;

        if (!fileInput.files || fileInput.files.length === 0) {
          showAlert("warning", "Nie wybrano pliku", "uploadExcelModal");
          return;
        }

        const file = fileInput.files[0];

        // Weryfikacja typu pliku
        if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
          showAlert(
            "danger",
            "Nieprawidłowy format pliku. Akceptowane są tylko pliki .xlsx lub .xls",
            "uploadExcelModal"
          );
          return;
        }

        // Tworzenie FormData
        const formData = new FormData();
        formData.append("file", file);
        formData.append("replace", replaceExisting);

        // Wyświetl informację o ładowaniu
        document.getElementById("submitExcelUpload").disabled = true;
        document.getElementById("submitExcelUpload").innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Wgrywanie...';

        // Wysyłanie pliku do API
        fetch("/api/upload-excel", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((result) => {
            document.getElementById("submitExcelUpload").disabled = false;
            document.getElementById("submitExcelUpload").innerHTML =
              "Wgraj plik";

            if (result.status === "success") {
              // Zamknij modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("uploadExcelModal")
              );
              modal.hide();

              // Pokaż powiadomienie
              showAlert("success", "Plik został pomyślnie wgrany");

              // Odśwież dane
              loadExcelData();
            } else {
              showAlert(
                "danger",
                "Błąd wgrywania pliku: " + result.message,
                "uploadExcelModal"
              );
            }
          })
          .catch((error) => {
            console.error("Błąd podczas wgrywania pliku:", error);
            document.getElementById("submitExcelUpload").disabled = false;
            document.getElementById("submitExcelUpload").innerHTML =
              "Wgraj plik";
            showAlert(
              "danger",
              "Błąd podczas wgrywania pliku",
              "uploadExcelModal"
            );
          });
      }

      // Funkcja wyświetlająca alert z informacją
      function showAlert(type, message, containerId = null) {
        let alertContainer;

        if (containerId) {
          // Jeśli podano konkretny kontener (np. wewnątrz modala)
          alertContainer = document.querySelector(`#${containerId} .alert`);
          if (!alertContainer) {
            alertContainer = document.createElement("div");
            alertContainer.className = "alert mt-3";
            document
              .querySelector(`#${containerId} .modal-body`)
              .appendChild(alertContainer);
          }
        } else {
          // Domyślny kontener na alerty
          alertContainer = document.getElementById("excelStatusAlert");
        }

        // Ustaw typ alertu
        alertContainer.className = `alert alert-${type}`;
        alertContainer.innerHTML = message;
        alertContainer.style.display = "block";

        // Automatyczne ukrywanie alertu po czasie (jeśli nie jest w modalu)
        if (!containerId) {
          setTimeout(() => {
            alertContainer.style.display = "none";
          }, 5000);
        }
      }
    </script>
  </body>
</html>
